# Программа управления 4-канальным реле  

## Общее описание
Этот проект представляет собой программу для управления 4-канальным модулем реле на базе ESP32S3. Устройство предназначено для удаленного управления реле через Wi-Fi. Программа запускает на чипе ESP32S3 http-сервер с простейшим REST API, позволяющим контролировать реле через HTTP-запросы.    
![Сам модуль реле выглядит так](https://raw.githubusercontent.com/houseofbigseals/esp32_relay/76ce90aca32eedb2ea658aa2c29895409198d6c7/image.png)   
Модуль может контролировать 4 канала реле, а также датчики температуры ds18b20 и DHT-XX (благодаря коду от [zorxx](https://github.com/zorxx/dht)). Для контроля температуры самого девайса на плате размещен датчик HDC1080.
В проекте используется реализация wireguard для esp32 от [trombik](https://github.com/trombik/esp_wireguard) и его форк [droscy](https://github.com/droscy/esp_wireguard)  

DHT11 измеряет температуру и влажность вне фитотрона, а DHT22 - внутри фитотрона. ds18b20 измеряет ремпературу в корневом модуле.  

## Сетевые интерфейсы
Устройство  доступно через следующие сетевые интерфейсы:
- Локальный IPv4 адрес - Выглядит как "192.168.0.123". обычно назначается роутером случайно, поэтому непригоден к использованию. 
- Статический IPv4 адрес в сети Wireguard. Выглядит как "10.10.0.8". По нему может быть доступен удаленно, если клиент тоже подключен к впн-сети.  
- Статический локальный адрес mDNS. Выглядит как "esp32_relay_4.local". Вам нужен mDNS сервис типа Avahi чтобы найти в локальной сети девайс по его имени, но это быстрее чем через впн.  

## Подключение к Wi-Fi
Пока что ssid и пароль вайфай сети можно передать девайсу только через перепрошивку прибора:(

## Веб-интерфейс
Устройство поддерживает REST API для управления реле. Ниже приведен список доступных методов:  
 

### GET Получение состояния всех реле и датчиков
Метод GET на адрес /info  
Пример запроса через curl  (будем использовать адрес устройства 10.10.0.7 для примера)
```
curl -X GET http://10.10.0.7/info
```

Пример ответа:
```
{
	"ch0":	0,
	"ch1":	1,
	"ch2":	1,
	"ch3":	0,
	"pcb_temp":	-255,
	"roots_temp":	-255,
	"ext_temp":	-255,
	"ext_hum":	-255,
	"int_temp":	-255,
	"int_hum":	-255,
	"uptime":	132
}
```
Значение -255 в поле конкретного датчика означает что датчик не установлен или сломан. Uptime измеряется в секундах с последней перезагрузки.

### Получение состояния конкретного датчика
Можно получить состояние конкретного датчика с помощью GET-запроса на следующие адреса: (будем использовать адрес устройства 10.10.0.7 для примера)  
```
curl -X GET http://10.10.0.7/ext_temp
```
Температура воздуха вне фитотрона, полученная от датчика dht11. Отдает одно число в текстовом виде. Значение -255 в ответе означает что датчик не установлен или сломан.  

```
curl -X GET http://10.10.0.7/ext_hum
```
Влажность воздуха вне фитотрона, полученная от датчика dht11. Отдает одно число в текстовом виде. Значение -255 в ответе означает что датчик не установлен или сломан.   

```
curl -X GET http://10.10.0.7/int_temp
```
Температура воздуха внутри аквариума, полученная от датчика dht22. Отдает одно число в текстовом виде. Значение -255 в ответе означает что датчик не установлен или сломан. 


```
curl -X GET http://10.10.0.7/int_hum
```
Влажность воздуха внутри аквариума, полученная от датчика dht22. Отдает одно число в текстовом виде. Значение -255 в ответе означает что датчик не установлен или сломан.  

```
curl -X GET http://10.10.0.7/roots_temp
```
Температура корневой зоны растений, полученная от сенсора ds18b20. Отдает одно число в текстовом виде. Значение -255 в ответе означает что датчик не установлен или сломан.  


### Изменение состояния реле
Метод POST на адрес /relay. Не забудьте установить тип передаваемых данных в заголовке на 'Content-Type: application/json'  
В качестве аргумента нужно передать JSON слудующего вида:  

```
{"channel":3,"state": 1}
```
Где channel - номер канала реле, может быть от 0 до 3, state - желаемое состояние реле - должно быть или 0 или 1. 


Пример запроса через curl   (будем использовать адрес устройства 10.10.0.7 для примера)  
```
curl -X POST http://10.10.0.7/relay -H 'Content-Type: application/json' -d '{"channel":1,"state": 1}'
```

При некорректном запросе выдает следующие ошибки в виде текстовой строки:
1. RESULT: ERROR Failed to parse JSON - при некорректном формате JSON
2. RESULT: ERROR Invalid channel type - при некорректном типе номера канала
3. RESULT: ERROR Invalid state type - при некорректном типе нового состояния
4. RESULT: ERROR invalid params! - при корректном но невозможном номере канала или состоянии


При правильном запросе отдает строку вида:  
```
RESULT: SUCCESS
 Relay: 1, set to state: 1
```

### Удаленная перезагрузка устройства
Метод POST на адрес /relay. Не забудьте установить тип передаваемых данных в заголовке на 'Content-Type: text/html'. Важно передать в качестве аргумента строку "force_reset", только тогда система перезапустится.  

Пример запроса через curl   
```
curl -X POST http://10.10.0.7/reset -H 'Content-Type: text/html' -d 'force_reset'

```

Пример ответа на некорректный запрос:
```
User have sent incorrect reset command, so no rebooting
```

Пример ответа на корректный запрос:
```
User have sent force reset command, so rebooting
```
После этого девайс перезагрузится.  

## Как билдить код
Очень важно выставить правильные параметры в sdkconfig, иначе wireguard просто не соберется. 
Еще программа используем измененную схему разделов в памяти, так что надо подключить использование partitions.csv в разделе Flash  

